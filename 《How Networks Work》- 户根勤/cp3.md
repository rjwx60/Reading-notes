
## 集线器 交换机 路由器

### 一、集线器的包转发操作
——>  网卡中的 PHY(MAU)模块 负责将包转换成电信号，信号通过 RJ-45 接口进入中继电路(双绞线)，并将输入信号广播到集线器的所有端口上  
——>  信号传递会有衰减，双绞线的设计是为了减轻噪声的影响，噪声的产生是由于网线周围的电磁波接触导体产生与原本信号不一样的电流  

影响网线的噪声分为两种：  
一种是：由电机、荧光灯、CRT显示器等设备泄露出来的外源性电磁波  
一种是：从网线中相邻信号线中泄露出来的内源性电磁波，别名串扰  

解决一：使用拧麻花的方式  
解决二：使用合理的双绞线的缠绕方式  

<!-- ![图1](https://github.com/rjwx60/Reading-notes/blob/master/%E3%80%8AHow%20Networks%20Work%E3%80%8B-%20%E6%88%B7%E6%A0%B9%E5%8B%A4/imgs/3-01.png) -->
<img src="https://github.com/rjwx60/Reading-notes/raw/master/%E3%80%8AHow%20Networks%20Work%E3%80%8B-%20%E6%88%B7%E6%A0%B9%E5%8B%A4/imgs/3-01.png" alt="图1" width="400px">


### 二、交换机的包转发操作
——>  将所有接收包缓存  
——>  根据包的 MAC地址，查询本机 MAC地址表：  
——>  若查询成功但目标端口 和 包的源端口相同，则直接丢弃  
——>  若查询失败，将包发往所有端口  
——>  若查询成功，将包发往相应的端口，并对MAC地址进行维护  
1、将发送方MAC地址以及其输入的端口号写入  
2、删除地址表中的某条记录（不能永久有效，过段时间后删除）  

<!-- ![图2](https://github.com/rjwx60/Reading-notes/blob/master/%E3%80%8AHow%20Networks%20Work%E3%80%8B-%20%E6%88%B7%E6%A0%B9%E5%8B%A4/imgs/3-02.png) -->
<img src="https://github.com/rjwx60/Reading-notes/raw/master/%E3%80%8AHow%20Networks%20Work%E3%80%8B-%20%E6%88%B7%E6%A0%B9%E5%8B%A4/imgs/3-02.png" alt="图2" width="400px">




### 三、路由器的包转发操作
——>  不同类型的端口接收网络包  
——>  信号到达网线接口部分  
——>  PHY(MAU)模块 和 MAC模块转换成数字信息，通过末尾的 FCS 进行错误校验，无错接收，否则丢弃  
——>  接收包后，丢弃包开头的 MAC头部  
——>  根据 IP头部，查询路由表判断转发目标  
——>  根据子网掩码中的值判断网络号的比特数，并匹配相应数量的比特  
——>  若匹配到多条记录，先找网络号比特数最长的一条，然后转发。网络比特数越长，主机号越少  
——>  若存在多条网络号长度相同的记录，则根据跃点计数来判断。此数越小，代表该路由越近  
——>  若无法找到匹配的记录，前期处理是直接丢弃这个包，后来有了默认路由/网关，则会转发到默认网关 0.0.0.0  
——>  更新 IP头部 中的 TTL值。包每经过一个路由，此值就会减 1，变为 0 时则丢弃这个包  
——>  根据输出端口能传输的最大长度，使用IP协议中定义的分片功能对包进行拆分发送。因为不同线路和局域网类型各自能传输的最大包长度不同  
——>  注意：TCP 的拆分数据是讲数据装到包之前进行的，而 IP 分片是对一个完整的包进行拆分的过程  
——>  注意：端口能输出的最大长度 - 头部 = MTU，即一个包能传输的最大数据长度  
——>  发送操作（此处跟计算机发送过程一致，略过，P172）  


#### 路由器的附加功能：地址转换和包过滤
##### 地址转换：
将公司内网分成：对互联网的对外部分，和对公司内部设备的对内部分，前者使用使用公有地址，后者使用私有地址  
而内网设备需通过某些机制才能同外网进行连接的机制称地址转换  

地址转换原理：在转发网络包时，对IP头部中的 IP地址 和 端口号 进行改写  
地址转换设备：根据对应表查找私有地址 和 公有地址的映射，再改写地址和端口号后转发  

地址转换好处：防止非法入侵  
地址转换好处：有效利用IP地址，减少固定地址的浪费情况  

##### 包过滤：
转发包时，根据 MAC头部、IP头部、TCP头部的内容，按照事先设置好的规则，决定转发亦或丢弃  


#### 路由器与交换机区别
路由器：  
基于IP设计  
根据 IP头部 中的 IP地址 转发目标  
接收包，查询转发目标，再由相应的端口，作为发送方将包发送出去  
将接收到的包同路由表中的目标地址的网络号进行比较，不管主机号  
对路由表的维护同包的转发操作是相互独立的，利用各种路由协议去维护  

交换机：  
基于以太网设计  
根据 MAC头部 的 MAC地址 转发目标  
只是将包转发，本身不具有发送方的资格  
交换机在地址表中需要完全一致的匹配  
对 MAC地址 的维护是包转发操作中的一步  

IP(路由器)：负责将包送达通信对象这一整体过程；  
以太网(交换机)：负责将包传输到下一个路由器的过程；  



### 零碎
以太网的本质：正负变化的电压

交换机具有集线器不具备的全双工模式，可同时收发包。  
全双工和半双工模式的自动切换功能称为自动协商。  
当没有数据传输时，会填充特定排列的脉冲信号，以检测对方是否正常工作，并把自身支持的工作模式、传输速率告知对方  

可将路由器的转发模块想象为 IP模块，将端口模块想象成网卡，转发模块委托端口模块发送    
路由器的端口模块：支持局域网以外的多种通信技术，如：ADSL、FTTH 以及各种宽带专线  
